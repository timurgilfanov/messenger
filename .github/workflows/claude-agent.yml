name: Claude Agent

on:
  issues:
    types: [labeled]

jobs:
  resolve-issue:
    if: github.event.label.name == 'agent'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.gradle/configuration-cache
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - run: chmod +x gradlew

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          label_trigger: "agent"
          prompt: |
            You are an autonomous AI agent resolving a GitHub issue.

            WORKFLOW:
            1. Read the issue. It uses a structured template with: reference pattern, what to do, scope boundaries, acceptance criteria, test requirements, and pre-made decisions.
            2. Study the reference pattern file or PR mentioned in the issue.
            3. Implement the solution following CLAUDE.md conventions.
            4. Run verification (preCommit uses git staged files, so run each step directly):
               ./gradlew ktlintFormat detekt --auto-correct
               ./gradlew lintMockDebug
               ./gradlew testMockDebugUnitTest -PtestCategory=timur.gilfanov.messenger.annotations.Architecture
               ./gradlew testMockDebugUnitTest -PtestCategory=timur.gilfanov.messenger.annotations.Unit
               ./gradlew testMockDebugUnitTest -PtestCategory=timur.gilfanov.messenger.annotations.Component
            5. If any step fails, fix and re-run.
            6. Create a PR referencing the issue number.
          claude_args: "--max-turns 25 --model claude-sonnet-4-20250514"
